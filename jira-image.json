{
  "builders": [
    {
      "name": "yandex",
      "type": "yandex",
      "ssh_username": "cloud-user",
      "ssh_timeout": "20m",

      "source_image_folder_id": "{{user `source_image_folder_id`}}",
      "source_image_family": "{{user `source_image_family`}}",

      "zone": "{{user `zone`}}",
      "folder_id": "{{user `folder_id`}}",
      "subnet_id": "{{user `subnet_id`}}",

      "instance_name": "{{user `instance_name`}}",
      "instance_cores": "{{user `instance_cores`}}",
      "instance_mem_gb": "{{user `instance_mem_gb`}}",
      "disk_type": "network-hdd",
      "disk_size_gb": "{{user `disk_size_gb`}}",
      "use_ipv4_nat": "true",

      "image_family": "centos-8-jira",
      "image_name": "centos-8-jira-image-{{isotime | clean_resource_name}}",
      "image_description": "JIRA DC Image"
    }
  ],

  "provisioners": [
    {
      "type": "ansible",
      "playbook_file": "{{ user `ansible_dir` }}/playbook.yml",
      "ansible_env_vars": [ "JIRA_SHARED_HOME={{ user `jira_shared_home` }}" ],
      "roles_path": "{{ user `ansible_dir` }}/roles",
      "empty_groups": "consul-server"
    },

    {
      "type": "shell",
      "execute_command": "sudo {{.Vars}} sh {{.Path}}",
      "environment_vars": [
          "CONSUL_RETRY_JOIN={{ user `consul_retry_join` }}",
          "CONSUL_CENTER={{ user `consul_center` }}",
          "CONSUL_DOMAIN={{ user `consul_domain` }}",
          "JIRA_SHARED_HOME={{ user `jira_shared_home` }}"
      ],
      "scripts": [
        "{{ user `scripts_dir` }}/cloud-init.sh",
        "{{ user `scripts_dir` }}/cleanup.sh"
      ]
    }
  ],

"post-processors": [
    {
      "type": "manifest",
      "output": "manifest.json",
      "strip_path": true,
      "custom_data": {
        "source_image_id": "{{ build `SourceImageID` }}"
      }
    }
],

  "variables": {
    "source_image_folder_id": "b1gk6m11jdpeg9768aol",
    "source_image_family": "centos-8-dtc-base",
    "zone": "ru-central1-a",
    "folder_id": "b1gk6m11jdpeg9768aol",
    "subnet_id": "e9b5q3c33jv292vb82lk",
    "instance_cores": "4",
    "instance_mem_gb": "4",
    "disk_size_gb": "10",
	"ansible_dir": "{{ template_dir }}/provisioners/ansible",
    "scripts_dir": "{{ template_dir }}/provisioners/shell",

    "jira_shared_home": "/var/shared",

    "consul_retry_join": "consul-1",
    "consul_center": "dtc",
    "consul_domain": "consul"
  }
}
